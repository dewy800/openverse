<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <link rel="shortcut icon" href="https://raw.githubusercontent.com/WordPress/openverse/master/brand/icon.svg"/><!-- Generated with Sphinx 6.1.3 and Furo 2023.03.27 -->
        <title>Implementation Plan: Decoupling Popularity Calculations from the Data Refresh - Openverse documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">Openverse  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../../_static/logo_light.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../../_static/logo_dark.svg" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api/index.html">Django API</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../api/guides/index.html">Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/guides/quickstart.html">Quickstart guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/guides/test.html">Testing guide</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../api/reference/index.html">Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/reference/authentication_and_throttling.html">Authentication and Throttling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/reference/search_algorithm.html">Search Algorithm</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../catalog/index.html">Airflow catalog</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../changelogs/index.html">Changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../changelogs/api/index.html">API changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelogs/api/2023.04.23.23.22.14.html">2023.04.23.23.22.14</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelogs/api/2023.04.19.00.01.39.html">2023.04.19.00.01.39</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelogs/api/2023.04.18.15.27.15.html">2023.04.18.15.27.15</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../changelogs/frontend/index.html">Frontend changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelogs/frontend/2023.04.23.23.07.51.html">2023.04.23.23.07.51</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../changelogs/ingestion_server/index.html">Ingestion server changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../frontend/index.html">Nuxt frontend</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../frontend/guides/index.html">Guides</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../frontend/guides/analytics.html">Analytics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../frontend/guides/develop.html">Development guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../frontend/guides/quickstart.html">Quickstart guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../frontend/guides/test.html">Running frontend tests</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../frontend/reference/index.html">Reference</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../frontend/reference/feature_flags.html">Feature flags</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../frontend/reference/miscellaneous.html">Miscellaneous notes on the frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../frontend/reference/playwright_tests.html">Playwright tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../frontend/reference/storybook_tests.html">Storybook tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../frontend/reference/testing_guidelines.html">Testing Guidelines</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../general/index.html">General development guidelines</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../general/deployment.html">Deployments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../general/general_setup.html">General setup guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../general/https.html">Testing HTTPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../general/logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../general/publish.html">Publish</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../general/quickstart.html">Quickstart guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../general/run.html">Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../general/test.html">Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../general/zero-downtime-database-management.html">Zero Downtime and Database Management</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../ingestion_server/index.html">Ingestion server</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../ingestion_server/guides/index.html">Guides</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../ingestion_server/guides/quickstart.html">Quickstart guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ingestion_server/guides/test.html">Testing guide</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../meta/index.html">Managing the Openverse</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../meta/dev_flow.html">Development workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../meta/github_contribution_practices.html">GitHub contribution practices</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../meta/ci_cd/index.html">CI + CD workflow</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../meta/ci_cd/actions.html">Actions</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../meta/ci_cd/jobs/index.html">Jobs</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../meta/ci_cd/jobs/preparation.html">Preparation jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../meta/ci_cd/jobs/frontend.html">Frontend jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../meta/ci_cd/jobs/docker_preparation.html">Docker jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../meta/ci_cd/jobs/docker_publishing.html">Docker publishing jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../meta/ci_cd/jobs/catalog.html">Catalog jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../meta/ci_cd/jobs/ingestion_server.html">Ingestion server jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../meta/ci_cd/jobs/api.html">API jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../meta/ci_cd/jobs/documentation.html">Documentation jobs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../meta/ci_cd/flow.html">Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../meta/ci_cd/proof_of_functionality.html">Proof-of-functionality</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../meta/decision_making/index.html">Openverse Decision-Making Process</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../meta/decision_making/additional_practices.html">Additional practices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../meta/decision_making/how_to_use.html">How to follow the process in different settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../meta/decision_making/process_description.html">Process description</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../meta/documentation/index.html">Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../meta/documentation/guidelines.html">Documentation Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../meta/documentation/quickstart.html">Quickstart guide</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../index.html">Projects</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../planning.html">Project Planning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../templates/implementation-plan.html">Implementation Plan Template</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../templates/project-proposal.html">Project Proposal Template</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../3d_model_support/index.html">3D Model Support</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../3d_model_support/20220221-project_proposal.html">Project Proposal - 2022-02-21</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../analytics/index.html">Analytics</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../analytics/20221006-implementation_plan_frontend.html">Implentation Plan: Frontend event tracking - 2022-10-06</a></li>
<li class="toctree-l3"><a class="reference internal" href="../analytics/20230307-backend_service.html">Implementation Plan: Analytics backend and visualisation service - 2023-03-07</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core_user_interface_improvement/index.html">Core User Interface Improvements</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core_user_interface_improvement/20230314-project_proposal_core_ui_improvement.html">Project Proposal - 2023-03-14</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../detecting_sensitive_textual_content/index.html">Detecting and Blurring Sensitive Textual Content</a><input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../detecting_sensitive_textual_content/20230308-implementation_plan_filtering_and_designating_results_with_sensitive_textual_content.html">2023-03-08 Implementation Plan: Filtering and designating results with sensitive textual content</a></li>
<li class="toctree-l3"><a class="reference internal" href="../detecting_sensitive_textual_content/20230309-implementation_plan_sensitive_terms_list.html">2023-03-09 Implementation Plan: Sensitive Terms List</a></li>
<li class="toctree-l3"><a class="reference internal" href="../detecting_sensitive_textual_content/20230309-project_proposal_detecting_sensitive_textual_content.html">2023-03-09 Project Proposal</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../document_all_media_properties/index.html">Document all media properties</a><input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../document_all_media_properties/20230307-project_proposal.html">Due date:</a></li>
<li class="toctree-l3"><a class="reference internal" href="../document_all_media_properties/20230307-project_proposal.html#assigned-reviewers">Assigned reviewers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../document_all_media_properties/20230307-project_proposal.html#description">Description</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../feature_flags/index.html">Feature Flags</a><input class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../feature_flags/20220309-project_proposal.html">Project Proposal - 2022-03-09</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../frontend_ui_state_cookie/index.html">Frontend UI State Cookie</a><input class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../frontend_ui_state_cookie/20220218-project_proposal.html">2022-02-18 Project Propsal: Frontend UI State Cookie</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../monitoring/index.html">Monitoring</a><input class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" role="switch" type="checkbox"/><label for="toctree-checkbox-28"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../monitoring/20220307-project_proposal.html">Project Proposal - 2022-03-07</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../monorepo/index.html">Monorepo</a><input class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" role="switch" type="checkbox"/><label for="toctree-checkbox-29"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../monorepo/20221124-project_proposal.html">Project Proposal - 2022-11-24</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../search_relevancy_sandbox/index.html">Search Relevancy Sandbox</a><input class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" role="switch" type="checkbox"/><label for="toctree-checkbox-30"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../search_relevancy_sandbox/20230331-project_proposal_search_relevancy_sandbox.html">Project Proposal - 2023-03-31</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../trust_and_safety/index.html">Trust &amp; Safety</a><input class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" role="switch" type="checkbox"/><label for="toctree-checkbox-31"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../trust_and_safety/20230109-trust_and_safety_preliminary_overview_and_exploration.html">2023-01-09 Project Proposal</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../visual_regression_testing/index.html">Visual Regression Testing</a><input class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" role="switch" type="checkbox"/><label for="toctree-checkbox-32"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../visual_regression_testing/20220217-implementation_plan.html">Implementation Plan - 2022-02-17</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../vuex_to_pina_conversion/index.html">Pinia Conversion</a><input class="toctree-checkbox" id="toctree-checkbox-33" name="toctree-checkbox-33" role="switch" type="checkbox"/><label for="toctree-checkbox-33"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../vuex_to_pina_conversion/20220223-project_proposal.html">Project Proposal - 2022-02-23</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../terms_of_service.html">Openverse API Terms of Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">External links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://openverse.org">Openverse</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/WordPress/openverse">GitHub</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/WordPress/openverse/edit/main/documentation/projects/proposals/popularity_optimizations/20230420-implementation_plan_popularity_optimizations.md" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="implementation-plan-decoupling-popularity-calculations-from-the-data-refresh">
<h1>Implementation Plan: Decoupling Popularity Calculations from the Data Refresh<a class="headerlink" href="#implementation-plan-decoupling-popularity-calculations-from-the-data-refresh" title="Permalink to this heading">#</a></h1>
<!-- See the implementation plan guide for more information: https://github.com/WordPress/openverse/tree/19791f51c063d0979112f4b9f4eeace04c8cf5ff/docs/projects#implementation-plans-status-in-rfc -->
<!-- This template is exhaustive and may include sections which aren't relevant to your project. Feel free to remove any sections which would not be useful to have. -->
<section id="reviewers">
<h2>Reviewers<a class="headerlink" href="#reviewers" title="Permalink to this heading">#</a></h2>
<!-- Choose two people at your discretion who make sense to review this based on their existing expertise. Check in to make sure folks aren't currently reviewing more than one other proposal or RFC. -->
<ul class="simple">
<li><p>[ ] &#64;AetherUnbound</p></li>
<li><p>[ ] &#64;obulat</p></li>
</ul>
</section>
<section id="project-links">
<h2>Project links<a class="headerlink" href="#project-links" title="Permalink to this heading">#</a></h2>
<!-- Enumerate any references to other documents/pages, including milestones and other plans -->
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/WordPress/openverse/issues/433">Project Thread</a></p></li>
<li><p><a class="reference external" href="https://docs.openverse.org/projects/proposals/popularity_optimizations/20230406-project_proposal_popularity_optimizations.md">Project Proposal</a></p></li>
</ul>
</section>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h2>
<!-- A brief one or two sentence overview of the implementation being described. -->
<p>This document describes a method for separating the popularity calculation steps
from the data refresh process, allowing the data refresh to be re-enabled
independently of popularity calculations.</p>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this heading">#</a></h2>
<p>To improve search relevancy, we boost records in our search results relative to
a normalized popularity score. Because the process of calculating these scores
and pushing them into the API DB (referred to as “data refresh”) is complex, it
may be beneficial to briefly outline the tables and views currently used.</p>
<p>For simplicity, I will use <code class="docutils literal notranslate"><span class="pre">image</span></code> as an example, but note that equivalent
structures exist for <code class="docutils literal notranslate"><span class="pre">audio</span></code> and will exist for any media types added in the
future. Descriptions are not exhaustive; some details that are not relevant have
been omitted for brevity.</p>
<section id="image">
<h3><code class="docutils literal notranslate"><span class="pre">image</span></code><a class="headerlink" href="#image" title="Permalink to this heading">#</a></h3>
<p>The ‘main’ image table. Rows in this table may contain <strong>raw</strong> popularity data
in the <code class="docutils literal notranslate"><span class="pre">meta_data</span></code> column, such as the number of times this image has been
viewed or downloaded.</p>
<p>This table is updated by <strong>ingestion</strong>, which may:</p>
<ul class="simple">
<li><p>insert newly ingested images</p></li>
<li><p>update previously ingested images (for example, by updating raw popularity
data)</p></li>
</ul>
</section>
<section id="image-popularity-metrics">
<h3><code class="docutils literal notranslate"><span class="pre">image_popularity_metrics</span></code><a class="headerlink" href="#image-popularity-metrics" title="Permalink to this heading">#</a></h3>
<p>A table which contains known ‘metrics’: that is, the name of the meta<em>data field
which contains raw popularity data for each provider. _Not all providers have a
configured popularity metric.</em></p>
<p>This table only needs to be updated when a metric is added or modified.</p>
</section>
<section id="image-popularity-constants">
<h3><code class="docutils literal notranslate"><span class="pre">image_popularity_constants</span></code><a class="headerlink" href="#image-popularity-constants" title="Permalink to this heading">#</a></h3>
<p>A materialized view which calculates, for each provider that supports popularity
data, a popularity constant that can be used to normalize raw popularity scores.
This constant is calculated using the 85th percentile of the given metric (total
views, etc). Because of this, the constant needs to be periodically updated for
accuracy as more data is consumed.</p>
<p>Refreshing this view results in the constants being recalculated. We currently
do this once a month. It must also be done whenever a new metric is added.</p>
</section>
<section id="image-view">
<h3><code class="docutils literal notranslate"><span class="pre">image_view</span></code><a class="headerlink" href="#image-view" title="Permalink to this heading">#</a></h3>
<p>A materialized view sourced from the <code class="docutils literal notranslate"><span class="pre">image</span></code> table, which adds the calculated
<code class="docutils literal notranslate"><span class="pre">standardized_popularity</span></code> column. This normalized popularity score is calculated
by a simple operation using the raw score and the popularity constant.</p>
<p>The effect of refreshing the view is to:</p>
<ul class="simple">
<li><p>Add all images which were ingested since the last time the view was refreshed,
and calculate their popularity</p></li>
<li><p>Update existing records which may have been modified on the <code class="docutils literal notranslate"><span class="pre">image</span></code> table
since the last refresh</p></li>
<li><p>Update the <code class="docutils literal notranslate"><span class="pre">standardized_popularity</span></code> for all records to use <em>the current
popularity constant</em></p></li>
</ul>
<p>In a data refresh, the data from this view is copied into a new table in the API
DB, which is used to build new Elasticsearch indices and eventually swapped with
the live tables. As a result, the view <strong>must</strong> be refreshed before the data
refresh can run, or newly ingested data would not make it to the API.</p>
</section>
</section>
<section id="outlined-steps">
<h2>Outlined Steps<a class="headerlink" href="#outlined-steps" title="Permalink to this heading">#</a></h2>
<!-- Describe the implementation step necessary for completion. -->
<p>The basic strategy proposed here for decoupling popularity calculations from the
data refresh is:</p>
<ol class="arabic simple">
<li><p>Add <code class="docutils literal notranslate"><span class="pre">standardized_popularity</span></code> as a <code class="docutils literal notranslate"><span class="pre">nullable</span></code> column on the <code class="docutils literal notranslate"><span class="pre">image</span></code> and
<code class="docutils literal notranslate"><span class="pre">audio</span></code> tables. (<a class="reference internal" href="#add-standardized-popularity-to-the-media-tables">link</a>)</p></li>
<li><p>Update the <code class="docutils literal notranslate"><span class="pre">provider_dag_factory</span></code> to calculate <code class="docutils literal notranslate"><span class="pre">standardized_popularity</span></code> <strong>at
ingestion</strong>.
(<a class="reference internal" href="#Update-provider-DAGs-to-calculate-standardized-popularity"><span class="xref myst">link</span></a>)</p></li>
<li><p>Create a new <code class="docutils literal notranslate"><span class="pre">popularity_refresh</span></code> DAG
(<a class="reference internal" href="#create-a-popularity-refresh-dag">link</a>) which:</p>
<ol class="arabic simple">
<li><p>Recalculates the popularity constants</p></li>
<li><p>Updates the <code class="docutils literal notranslate"><span class="pre">standardized_popularity</span></code> score for existing records, using
the new constants.</p></li>
</ol>
</li>
<li><p>Remove the popularity calculation steps from the data refresh DAGs.
(<a class="reference internal" href="#remove-popularity-steps-from-the-data-refresh-dags">link</a>)</p></li>
<li><p>Begin running the data refresh directly from the media tables, and drop the
materialized views. (<a class="reference internal" href="#run-the-data-refresh-from-the-media-tables">link</a>)</p></li>
</ol>
<p>More details about each of these steps, and the order in which they must be
implemented, is included in the following sections.</p>
<section id="add-standardized-popularity-to-the-media-tables">
<h3>Add standardized popularity to the media tables<a class="headerlink" href="#add-standardized-popularity-to-the-media-tables" title="Permalink to this heading">#</a></h3>
<p>This step is simple:</p>
<div class="highlight-pgsql notranslate"><div class="highlight"><pre><span></span>ALTER TABLE image ADD COLUMN standardized_popularity DOUBLE PRECISION;
ALTER TABLE audio ADD COLUMN standardized_popularity DOUBLE PRECISION;
</pre></div>
</div>
<p>The column can (and indeed <em>must</em>) be nullable, as not all providers support
popularity data. Because this configuration exactly matches the schema of the
current <code class="docutils literal notranslate"><span class="pre">image_view</span></code> and <code class="docutils literal notranslate"><span class="pre">audio_view</span></code> matviews, we will be able to begin running
data refreshes directly off these tables with very few changes in the ingestion
server.</p>
<p>It should be noted that conventionally, storing calculated fields would be
considered a violation of database normalization principles. However, doing so
in this case will give us much better performance of the data refresh and also
save a significant amount of space, as it will enable us to drop the
materialized views.</p>
</section>
<section id="update-provider-dags-to-calculate-standardized-popularity">
<h3>Update provider DAGs to calculate standardized popularity<a class="headerlink" href="#update-provider-dags-to-calculate-standardized-popularity" title="Permalink to this heading">#</a></h3>
<p>Using the <code class="docutils literal notranslate"><span class="pre">ProviderDataIngester</span></code>, we can easily add standardized popularity
calculation to all of our providers at once <a class="footnote-reference brackets" href="#id2" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>.</p>
<ol class="arabic simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">provider_dag_factory.py</span></code>, add a new
<code class="docutils literal notranslate"><span class="pre">get_popularity_constants_and_metrics</span></code> task which runs prior to <code class="docutils literal notranslate"><span class="pre">pull_data</span></code>.
This task will fetch the <code class="docutils literal notranslate"><span class="pre">metric</span></code> and <code class="docutils literal notranslate"><span class="pre">constant</span></code> for this provider from the
<code class="docutils literal notranslate"><span class="pre">&lt;media&gt;_popularity_metrics</span></code> table.</p>
<ol class="arabic simple">
<li><p>We will need to fetch metrics and constants for <em>each media type</em>
supported by the provider, and return it as a dictionary. This information
will be posted to XComs.</p></li>
</ol>
</li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">provider_dag_factory.py</span></code>, read the popularity data from XComs and pass it
to the <code class="docutils literal notranslate"><span class="pre">pull_data</span></code> task and into the <code class="docutils literal notranslate"><span class="pre">init</span></code> for the <code class="docutils literal notranslate"><span class="pre">ProviderDataIngester</span></code>.</p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">ProviderDataIngester</span></code>, create a <code class="docutils literal notranslate"><span class="pre">get_popularity_enriched_record_data</span></code>
method as a wrapper for the abstract <code class="docutils literal notranslate"><span class="pre">get_record_data</span></code>. It should:</p>
<ol class="arabic simple">
<li><p>Call <code class="docutils literal notranslate"><span class="pre">get_record_data</span></code></p></li>
<li><p>Calculate standardized popularity using the popularity constant and metric
passed in from XComs</p></li>
<li><p>Return the results of <code class="docutils literal notranslate"><span class="pre">get_record_data</span></code>, with <code class="docutils literal notranslate"><span class="pre">standardized_popularity</span></code>
appended.</p></li>
</ol>
</li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">ProviderDataIngester#process_batch</span></code> to call
<code class="docutils literal notranslate"><span class="pre">get_popularity_enriched_record_data</span></code> instead of <code class="docutils literal notranslate"><span class="pre">get_record_data</span></code> <em>if
popularity constants exist for this provider</em>. The logic can be skipped for
providers that do not support popularity metrics.</p></li>
<li><p>Update the Media stores to accept <code class="docutils literal notranslate"><span class="pre">standardized_popularity</span></code>, defaulted to
<code class="docutils literal notranslate"><span class="pre">None</span></code>, and write to tsv.</p></li>
<li><p>Update the <code class="docutils literal notranslate"><span class="pre">columns</span></code> used in the loader sql to write this column to the
database.</p></li>
</ol>
<p>When this work is completed:</p>
<ul class="simple">
<li><p>Standardized popularity scores will be calculated at ingestion for all new
records</p></li>
<li><p>For non-dated DAGs, popularity scores will immediately be backfilled for
historical records as soon as the DAG has a successful run.</p></li>
<li><p>For dated DAGs, the existing reingestion DAGs will begin slowly backfilling
standardized popularity scores for historical records.</p></li>
</ul>
</section>
<section id="create-a-popularity-refresh-dag">
<h3>Create a <code class="docutils literal notranslate"><span class="pre">popularity_refresh</span></code> DAG<a class="headerlink" href="#create-a-popularity-refresh-dag" title="Permalink to this heading">#</a></h3>
<p>Once popularity calculation happens at ingestion (and assuming the media tables
are backfilled – more on that later), we need only handle the following cases:</p>
<ul class="simple">
<li><p>A new popularity metric is added (for a new or existing provider)</p></li>
<li><p>The popularity constants are recalculated</p></li>
</ul>
<p>In both cases, we need to refresh the <code class="docutils literal notranslate"><span class="pre">&lt;media&gt;_popularity_constants</span></code> view (in
order to recalculate constants). Note that once the constants have been updated,
<em>the provider DAGs will immediately pick up the new constant and begin using it
at ingestion</em>. All that remains is to update the scores for historical data.</p>
<p><strong>Note</strong>: It is true that our reingestion DAGs will also immediately begin
updating the standardized scores of historical data using the new constant.
However, this process is slow and some reingestion DAGs are currently running on
sparse schedules. I think it is still worth it to explicitly updates the scores
in this DAG, especially because that will allow us to use the DAG to do the
initial backfill.</p>
<p>As with our data refresh DAGs, we will use a factory to generate a
<code class="docutils literal notranslate"><span class="pre">popularity_refresh</span></code> DAG for each media type. The DAG will do the following:</p>
<ol class="arabic simple">
<li><p>Update the <code class="docutils literal notranslate"><span class="pre">&lt;media&gt;_popularity_metrics</span></code> table to include any newly added
metrics.</p></li>
<li><p>Refresh the <code class="docutils literal notranslate"><span class="pre">&lt;media&gt;_popularity_constants</span></code> view to recalculate the popularity
constants.</p>
<ol class="arabic simple">
<li><p>This is done <code class="docutils literal notranslate"><span class="pre">CONCURRENTLY</span></code> so that provider DAGs can continue reading
from the view while it updates.</p></li>
</ol>
</li>
<li><p>For each unique <code class="docutils literal notranslate"><span class="pre">provider</span></code> in the <code class="docutils literal notranslate"><span class="pre">&lt;media&gt;_popularity_constants</span></code> view,
generate a <code class="docutils literal notranslate"><span class="pre">refresh_&lt;provider&gt;_scores</span></code> task. The task will run an <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> of
the <code class="docutils literal notranslate"><span class="pre">standardized_popularity</span></code> on all records matching that provider which
were last updated before the task began.</p>
<ol class="arabic simple">
<li><p>We may consider running the <code class="docutils literal notranslate"><span class="pre">refresh_&lt;provider&gt;_scores</span></code> tasks in parallel
to speed up the update.</p></li>
<li><p>Optionally, we can hard code a <code class="docutils literal notranslate"><span class="pre">SKIPLIST</span></code> of providers that are present in
the <code class="docutils literal notranslate"><span class="pre">&lt;media&gt;_popularity_constants</span></code> view, but for which we do not want to
create a refresh task. We currently have some providers (Nappy, Rawpixel,
Stocksnap) that support popularity data but are not dated, meaning scores
for <strong>all</strong> of their records will be updated the next time the DAG runs.
<em>Note that some of these DAGs are on a <code class="docutils literal notranslate"><span class="pre">&#64;monthly</span></code> schedule however, which
means skipping them in this DAG could result in delayed recalculation
time.</em></p></li>
</ol>
</li>
<li><p>Report to Slack when the scores have finished updating.</p></li>
</ol>
<p>Some notes:</p>
<ul class="simple">
<li><p>The DAG will initially run on a <code class="docutils literal notranslate"><span class="pre">None</span></code> schedule, while we get a sense of how
long it will take to complete. Thereafter we will enable it on a <code class="docutils literal notranslate"><span class="pre">&#64;monthly</span></code>
schedule if possible, or quarterly if it proves too long-running.</p></li>
<li><p>This DAG can run completely independently of the data refresh. The data
refresh will always have access to the most recently ingested records, with
standardized popularity. They will at worst be calculated using slightly
outdated constants, which is the case today in production.</p></li>
</ul>
<section id="special-considerations-avoiding-deadlocks-and-timeouts">
<h4>Special Considerations: Avoiding Deadlocks and Timeouts<a class="headerlink" href="#special-considerations-avoiding-deadlocks-and-timeouts" title="Permalink to this heading">#</a></h4>
<p>The popularity refresh tasks must be written carefully to avoid deadlocks. The
key issues to understand are:</p>
<ul class="simple">
<li><p>Provider DAGs may be running and upserting historical data in the media tables
at the same time that popularity refresh tasks are updating <em>the same data</em>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">upsert_data</span></code> step of a provider DAG upserts all records in a single
transaction, meaning that the changes are not committed until all rows have
been upserted.</p></li>
</ul>
<p>If the popularity refresh task <em>also</em> updates all records for a provider in a
single transaction, a deadlock scenario could happen. Imagine that the records
‘A’ and ‘B’ already exist on the <code class="docutils literal notranslate"><span class="pre">image</span></code> table for Flickr, and the Flickr
reingestion DAG is reingesting them at the same time the <code class="docutils literal notranslate"><span class="pre">refresh_flickr_scores</span></code>
task is refreshing their popularity scores. Concurrent updates might happen in
this order:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Flickr Reingestion DAG</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">refresh_flickr_scores</span></code></p></th>
<th class="head"><p>Comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Upsert record A</p></td>
<td><p>Update record B</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>Upsert record B</p></td>
<td><p></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">refresh_flickr_scores</span></code> has a lock on the row containing record B, so the Flickr Reingestion DAG must wait.</p></td>
</tr>
<tr class="row-even"><td><p></p></td>
<td><p>Update record A</p></td>
<td><p>The Flickr Reingestion DAG has a lock on the row containing record A, so <code class="docutils literal notranslate"><span class="pre">refresh_flickr_scores</span></code> must wait. The transactions are now waiting on each other. Deadlock!</p></td>
</tr>
</tbody>
</table>
</div>
<p>We can avoid deadlock by noting that writes from a provider DAG will necessarily
<em>always have more up-to-date data</em>: so when a popularity refresh task encounters
a locked row, we can tell it to simply skip that record using <code class="docutils literal notranslate"><span class="pre">SKIP</span> <span class="pre">LOCKED</span></code>
(example code below).</p>
<p>We have now avoided deadlock but we still have a problem with our example: the
Flickr reingestion DAG must still wait for <code class="docutils literal notranslate"><span class="pre">refresh_flickr_scores</span></code> to release
the lock on record B. Our upsert task will hang and likely time out, as the
popularity refresh task will take a considerably long time to complete.</p>
<p>To avoid this, we must break up the popularity refresh into smaller
transactions, committing after every 10,000 rows are updated (this number can be
tweaked as necessary). This ensures that a concurrently running provider DAG
will only ever have to wait for a second or two before locked rows are released.</p>
<p>The approach is easiest explained with some sample code:</p>
<div class="highlight-pgsql notranslate"><div class="highlight"><pre><span></span>-- The final product will be generalized by provider and media type.
-- In a local test, this successfully updated ~1 million Flickr
-- records in ~6 seconds, while the reingestion DAG was running.
DO $$
DECLARE
  rows_per_loop int := 10000;
  min_row int := 1;
  max_row int;
  max_timestamp timestamp;
BEGIN
  -- We will use this to select rows that have not been recently updated.
  SELECT NOW() INTO max_timestamp;

  -- A temporary table storing the identifiers of all records that need
  -- to be updated, plus their row number. The row number will be used to
  -- paginate the results more efficiently than using OFFSET.
  CREATE TEMP TABLE rows_to_update AS
    SELECT ROW_NUMBER() over() row_id, identifier
    FROM image
    WHERE provider=&#39;flickr&#39; AND updated_on &lt; max_timestamp;
  CREATE INDEX ON rows_to_update(row_id);

  SELECT COUNT(*) INTO max_row FROM rows_to_update;

  -- Loop over `rows_to_update` 10k rows at a time, updating scores.
  -- Avoid deadlock using SKIP LOCKED
  FOR i IN min_row..max_row BY rows_per_loop LOOP
   UPDATE image
   SET standardized_popularity = standardized_image_popularity(
       image.provider,
       image.meta_data
   )
   WHERE identifier in (
       SELECT identifier FROM rows_to_update
       WHERE row_id &gt;= i AND row_id &lt; i+rows_per_loop
       FOR UPDATE SKIP LOCKED
   );
   -- COMMIT this batch
   COMMIT;
END LOOP;
END;
$$;
</pre></div>
</div>
<p>This is much less efficient than doing a single <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code>, but has clear
advantages:</p>
<ul class="simple">
<li><p>It allows provider DAGs to continue running unimpeded.</p></li>
<li><p>The data refresh can run at any time, even while the refresh tasks are
running.</p></li>
<li><p>Because updates are committed incrementally, each batch of updated scores will
be ‘live’ on the image table as soon as they are committed. Rather than
waiting for all rows to be calculated before making the update, as much
up-to-date data as possible will be present each time the data refresh runs.</p></li>
</ul>
</section>
</section>
<section id="remove-popularity-steps-from-the-data-refresh-dags">
<h3>Remove popularity steps from the data_refresh DAGs<a class="headerlink" href="#remove-popularity-steps-from-the-data-refresh-dags" title="Permalink to this heading">#</a></h3>
<p>We can simply remove the popularity tasks from the relevant data refresh DAG
factories. See the <code class="docutils literal notranslate"><span class="pre">Parallelizable</span> <span class="pre">Streams</span></code> section for more information on the
timing of this change.</p>
</section>
<section id="run-the-data-refresh-from-the-media-tables">
<h3>Run the data refresh from the media tables<a class="headerlink" href="#run-the-data-refresh-from-the-media-tables" title="Permalink to this heading">#</a></h3>
<p>Once the <code class="docutils literal notranslate"><span class="pre">image</span></code> and <code class="docutils literal notranslate"><span class="pre">audio</span></code> tables contain up-to-date standardized popularity
data, we can update the data refresh to read from these tables rather than their
respective materialized views. Because the schema of the media tables now
matches what the ingestion server already expects, we can simply change the
table name each place it is referenced:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">_get_shared_cols</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refresh_api_table</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_copy_data_query</span></code></p></li>
</ul>
</section>
</section>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading">#</a></h2>
<section id="tools-packages">
<h3>Tools &amp; packages<a class="headerlink" href="#tools-packages" title="Permalink to this heading">#</a></h3>
<!-- Describe any tools or packages which this work might be dependent on. If multiple options are available, try to list as many as are reasonable with your own recommendation. -->
<p>We should not need any additional dependencies.</p>
</section>
<section id="other-projects-or-work">
<h3>Other projects or work<a class="headerlink" href="#other-projects-or-work" title="Permalink to this heading">#</a></h3>
<!-- Note any projects this plan is dependent on. -->
<p>This does not depend on any existing projects.</p>
</section>
<section id="infrastructure">
<h3>Infrastructure<a class="headerlink" href="#infrastructure" title="Permalink to this heading">#</a></h3>
<!-- Note any infrastructure this plan is dependent on. -->
<p>This project directly affects our Catalog database schema, Airflow DAGs, and
ingestion server. All necessary changes are described in this document.</p>
<p>Notably, because this plan would allow us to drop the materialized <code class="docutils literal notranslate"><span class="pre">image_view</span></code>
and <code class="docutils literal notranslate"><span class="pre">audio_view</span></code>, we should net some DB storage savings in the long term.</p>
</section>
</section>
<section id="alternatives">
<h2>Alternatives<a class="headerlink" href="#alternatives" title="Permalink to this heading">#</a></h2>
<section id="duplicate-table">
<h3>Duplicate table<a class="headerlink" href="#duplicate-table" title="Permalink to this heading">#</a></h3>
<p>Another approach was considered which, rather than updating records directly on
the <code class="docutils literal notranslate"><span class="pre">image</span></code> table, would have instead created a duplicate table with updated
scores and ultimately swapped tables. This has the benefit of avoiding
concurrent writes to the <code class="docutils literal notranslate"><span class="pre">image</span></code> table, but the following disadvantages:</p>
<ul class="simple">
<li><p>While the duplicate table is being built, writes to the <code class="docutils literal notranslate"><span class="pre">image</span></code> table from
provider DAGs would need to be propagated to it via a <code class="docutils literal notranslate"><span class="pre">Trigger</span></code>. Thus the same
deadlocking precautions are necessary, and the writes must still be batched,
offering no improved performance.</p></li>
<li><p>This approach requires much more space for the duplicate table (although
roughly equivalent to the current materialized view approach).</p></li>
<li><p>This approach is much less efficient because it unnecessarily re-inserts
<strong>all</strong> rows, including those that do not support popularity data at all.</p></li>
</ul>
</section>
<section id="separate-image-popularity-view">
<h3>Separate <code class="docutils literal notranslate"><span class="pre">image_popularity</span></code> view<a class="headerlink" href="#separate-image-popularity-view" title="Permalink to this heading">#</a></h3>
<p>We considered keeping the <code class="docutils literal notranslate"><span class="pre">image</span></code> table as is, and an <code class="docutils literal notranslate"><span class="pre">image_popularity</span></code>
materialized view equivalent to the current <code class="docutils literal notranslate"><span class="pre">image_view</span></code>. A new,
non-materialized <code class="docutils literal notranslate"><span class="pre">image_view</span></code> would join <code class="docutils literal notranslate"><span class="pre">image</span></code> and <code class="docutils literal notranslate"><span class="pre">image_popularity</span></code> and be
used for the data refresh. The advantage is that the <code class="docutils literal notranslate"><span class="pre">image_popularity</span></code> view
could be refreshed independently of the data refresh; this approach would also
be very quick and easy to implement. The disadvantages:</p>
<ul class="simple">
<li><p>Would require an expensive <code class="docutils literal notranslate"><span class="pre">join</span></code> at the time of data refresh</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">image_popularity</span></code> view still needs to be refreshed, and will still take
an untenably long time.</p></li>
<li><p>When the data refresh runs, records that have not yet been refreshed in the
<code class="docutils literal notranslate"><span class="pre">image_popularity</span></code> view will make it to the API, but without any standardized
popularity score.</p></li>
</ul>
</section>
</section>
<section id="accessibility">
<h2>Accessibility<a class="headerlink" href="#accessibility" title="Permalink to this heading">#</a></h2>
<!-- Are there specific accessibility concerns relevant to this plan? Do you expect new UI elements that would need particular care to ensure they're implemented in an accessible way? Consider also low-spec device and slow internet accessibility, if relevant. -->
<p>As part of this project, we should add documentation for the new popularity
refresh DAGs and the calculations themselves.</p>
</section>
<section id="parallelizable-streams">
<h2>Parallelizable streams<a class="headerlink" href="#parallelizable-streams" title="Permalink to this heading">#</a></h2>
<!-- What, if any, work within this plan can be parallelized? -->
<p>The order of operations for this project is very important.</p>
<ol class="arabic simple">
<li><p>Add <code class="docutils literal notranslate"><span class="pre">standardized_popularity</span></code> column to media tables.</p></li>
<li><p>Update the Media stores to accept <code class="docutils literal notranslate"><span class="pre">standardized_popularity</span></code>, defaulted to
None, and write this column to tsv.</p></li>
<li><p>Update the provider DAGs to calculate <code class="docutils literal notranslate"><span class="pre">standardized_popularity</span></code> at ingestion,
and write to the database.</p></li>
<li><p>Create the <code class="docutils literal notranslate"><span class="pre">popularity_refresh</span></code> DAG factory.</p></li>
<li><p>Enable the <code class="docutils literal notranslate"><span class="pre">popularity_refresh</span></code> DAGs in production, to backfill scores on the
media tables.</p></li>
<li><p>Once the <code class="docutils literal notranslate"><span class="pre">popularity_refresh</span></code> DAGs have completed their initial run, update
the ingestion server to begin copying data from the media tables rather than
the matviews.</p></li>
<li><p>Remove the popularity steps from the data refresh DAGs.</p></li>
<li><p>Drop the materialized views.</p></li>
</ol>
<p>Steps 3 and 4 may be done in parallel.</p>
</section>
<section id="rollback">
<h2>Rollback<a class="headerlink" href="#rollback" title="Permalink to this heading">#</a></h2>
<!-- How do we roll back this solution in the event of failure? Are there any steps that can not easily be rolled back? -->
<p>These changes will only go into effect when we update the ingestion server to
begin reading from the media tables. We can rollback by reverting just this last
change. Consequently we should wait to drop the materialized views until we are
confident that the process is working.</p>
<p>Because we have a far smaller number of <code class="docutils literal notranslate"><span class="pre">audio</span></code> records, we should test the
process with <code class="docutils literal notranslate"><span class="pre">audio</span></code> first. We should also test the data refresh in staging.</p>
</section>
<section id="risks">
<h2>Risks<a class="headerlink" href="#risks" title="Permalink to this heading">#</a></h2>
<!-- What risks are we taking with this solution? Are there risks that once taken can’t be undone?-->
<p>This approach would add an additional column to our media tables; it also
requires a temp table used for storing the ids of rows that need to be updated.
There will be a net decrease in storage needed when the materialized views are
finally dropped, but in the interim we will use extra space.</p>
<p>We do not have a clear estimate for how long the popularity refresh DAG will
take, and a complete run is necessary before we can begin running the data
refresh. If the popularity refresh takes an extremely long time, this will delay
our ability to restart the image data refresh. <em>After</em> the initial run, we will
be able to data refresh without waiting for subsequent popularity refreshes –
but an extremely long popularity refresh time is still undesirable because it
could cause our popularity scores to become relatively outdated.</p>
<p>It’s also possible that we may see some increase in ingestion time for providers
with popularity data, due to:</p>
<ul class="simple">
<li><p>the addition of the calculations themselves. This should be insignificant as
the calculation runs in constant time, and the popularity constant/metric need
only be fetched once.</p></li>
<li><p>concurrent writes from the popularity refresh tasks. The batched approach will
prevent provider DAGs from hanging indefinitely while waiting on the
popularity refresh, but there may still be some competition for locks which
could add several seconds of waiting time. This is also unlikely to be
significant, especially as the <code class="docutils literal notranslate"><span class="pre">upsert_data</span></code> steps are not currently a
bottleneck in our provider DAGs.</p></li>
</ul>
</section>
<section id="prior-art">
<h2>Prior art<a class="headerlink" href="#prior-art" title="Permalink to this heading">#</a></h2>
<!-- Include links to documents and resources that you used when coming up with your solution. Credit people who have contributed to the solution that you wish to acknowledge. -->
<ul class="simple">
<li><p><a class="reference external" href="https://make.wordpress.org/openverse/2023/02/21/post-inaturalist-data-refresh-status/">Investigation into data refresh failures due to popularity calculation timeouts post-iNaturalist</a></p></li>
</ul>
<hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id2" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>There is one exception: iNaturalist does not use <code class="docutils literal notranslate"><span class="pre">get_record_data</span></code>, instead
doing its data processing in postgres. We do not need to do anything to
address this now because we do not track popularity data for iNaturalist;
<em>however</em>, if we want to add popularity data for it in the future we will
need to handle it separately.</p>
</aside>
</aside>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/WordPress/openverse" aria-label="GitHub"><svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Implementation Plan: Decoupling Popularity Calculations from the Data Refresh</a><ul>
<li><a class="reference internal" href="#reviewers">Reviewers</a></li>
<li><a class="reference internal" href="#project-links">Project links</a></li>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#background">Background</a><ul>
<li><a class="reference internal" href="#image"><code class="docutils literal notranslate"><span class="pre">image</span></code></a></li>
<li><a class="reference internal" href="#image-popularity-metrics"><code class="docutils literal notranslate"><span class="pre">image_popularity_metrics</span></code></a></li>
<li><a class="reference internal" href="#image-popularity-constants"><code class="docutils literal notranslate"><span class="pre">image_popularity_constants</span></code></a></li>
<li><a class="reference internal" href="#image-view"><code class="docutils literal notranslate"><span class="pre">image_view</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#outlined-steps">Outlined Steps</a><ul>
<li><a class="reference internal" href="#add-standardized-popularity-to-the-media-tables">Add standardized popularity to the media tables</a></li>
<li><a class="reference internal" href="#update-provider-dags-to-calculate-standardized-popularity">Update provider DAGs to calculate standardized popularity</a></li>
<li><a class="reference internal" href="#create-a-popularity-refresh-dag">Create a <code class="docutils literal notranslate"><span class="pre">popularity_refresh</span></code> DAG</a><ul>
<li><a class="reference internal" href="#special-considerations-avoiding-deadlocks-and-timeouts">Special Considerations: Avoiding Deadlocks and Timeouts</a></li>
</ul>
</li>
<li><a class="reference internal" href="#remove-popularity-steps-from-the-data-refresh-dags">Remove popularity steps from the data_refresh DAGs</a></li>
<li><a class="reference internal" href="#run-the-data-refresh-from-the-media-tables">Run the data refresh from the media tables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dependencies">Dependencies</a><ul>
<li><a class="reference internal" href="#tools-packages">Tools &amp; packages</a></li>
<li><a class="reference internal" href="#other-projects-or-work">Other projects or work</a></li>
<li><a class="reference internal" href="#infrastructure">Infrastructure</a></li>
</ul>
</li>
<li><a class="reference internal" href="#alternatives">Alternatives</a><ul>
<li><a class="reference internal" href="#duplicate-table">Duplicate table</a></li>
<li><a class="reference internal" href="#separate-image-popularity-view">Separate <code class="docutils literal notranslate"><span class="pre">image_popularity</span></code> view</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accessibility">Accessibility</a></li>
<li><a class="reference internal" href="#parallelizable-streams">Parallelizable streams</a></li>
<li><a class="reference internal" href="#rollback">Rollback</a></li>
<li><a class="reference internal" href="#risks">Risks</a></li>
<li><a class="reference internal" href="#prior-art">Prior art</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/scripts/furo.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    </body>
</html>